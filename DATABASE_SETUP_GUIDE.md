# دليل إعداد قاعدة البيانات ونظام المستخدمين

## 🎯 نظرة عامة

تم ربط قسم الإعدادات مع قاعدة البيانات وإنشاء نظام إدارة المستخدمين الكامل. يشمل النظام:

- ✅ **جدول المستخدمين** مع جميع الحقول المطلوبة
- ✅ **جدول إعدادات الأمان** مع إعدادات قابلة للتخصيص
- ✅ **نظام مصادقة متكامل** مع JWT وحماية كلمات المرور
- ✅ **API endpoints محدثة** لتستخدم قاعدة البيانات
- ✅ **نماذج قاعدة البيانات** للتعامل مع البيانات

## 🚀 خطوات الإعداد

### 1. إعداد قاعدة البيانات

#### الطريقة الأولى: استخدام phpMyAdmin (الأسهل)
1. افتح phpMyAdmin في المتصفح: `http://localhost/phpmyadmin`
2. قم بتسجيل الدخول (المستخدم: root، كلمة المرور: 123)
3. انقر على "Import" أو "استيراد"
4. اختر ملف `database/create_users_and_settings.sql`
5. انقر على "Go" أو "تنفيذ"

#### الطريقة الثانية: سطر الأوامر
```bash
# إذا كان MySQL في PATH
mysql -u root -p123 < database/create_users_and_settings.sql

# أو استخدم المسار الكامل لـ XAMPP
C:\xampp\mysql\bin\mysql.exe -u root -p123 < database/create_users_and_settings.sql
```

### 2. إعداد متغيرات البيئة

انسخ ملف `.env.example` إلى `.env.local`:

```bash
cp .env.example .env.local
```

أو أنشئ ملف `.env.local` يدوياً مع المحتوى التالي:

```env
MYSQL_HOST=localhost
MYSQL_USER=root
MYSQL_PASSWORD=123
MYSQL_DATABASE=hr_system
MYSQL_PORT=3306
JWT_SECRET=your-very-secure-secret-key-here
NEXT_PUBLIC_API_URL=http://localhost:9004
```

### 3. تشغيل التطبيق

```bash
npm run dev
```

## 👥 المستخدمين الافتراضيين

تم إنشاء المستخدمين التاليين:

| الاسم | البريد الإلكتروني | كلمة المرور | الدور |
|-------|------------------|-------------|-------|
| أحمد محمد | admin@company.com | admin123 | مدير النظام |
| فاطمة علي | hr@company.com | hr123 | مدير الموارد البشرية |
| محمد سالم | employee@company.com | emp123 | موظف |

## 🔒 إعدادات الأمان الافتراضية

- **المصادقة الثنائية**: غير مفعلة
- **انتهاء الجلسة**: مفعل (30 دقيقة)
- **سياسة كلمات المرور**: مفعلة
  - الحد الأدنى: 8 أحرف
  - يتطلب أرقام ورموز خاصة وأحرف كبيرة وصغيرة
- **محاولات تسجيل الدخول**: 5 محاولات قبل الحظر (15 دقيقة)
- **سجل التدقيق**: مفعل (90 يوم احتفاظ)
- **النسخ الاحتياطي**: يومي (30 يوم احتفاظ)
- **التشفير**: مفعل (AES-256)

## 🔧 اختبار النظام

### اختبار قاعدة البيانات
```bash
npm run test-db
```

### اختبار API endpoints

1. **تسجيل الدخول**:
```bash
curl -X POST http://localhost:9004/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@company.com","password":"admin123"}'
```

2. **جلب المستخدمين**:
```bash
curl http://localhost:9004/api/users \
  -H "Authorization: Bearer YOUR_TOKEN"
```

3. **جلب إعدادات الأمان**:
```bash
curl http://localhost:9004/api/security/settings \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 📁 الملفات المضافة/المحدثة

### ملفات قاعدة البيانات
- `database/schema.sql` - محدث مع جداول المستخدمين والإعدادات
- `database/create_users_and_settings.sql` - ملف منفصل لإنشاء النظام

### نماذج قاعدة البيانات
- `src/lib/models/User.ts` - نموذج المستخدمين
- `src/lib/models/SecuritySettings.ts` - نموذج إعدادات الأمان

### API Endpoints محدثة
- `src/app/api/auth/login/route.ts` - تسجيل دخول مع قاعدة البيانات
- `src/app/api/auth/change-password/route.ts` - تغيير كلمة المرور
- `src/app/api/users/route.ts` - إدارة المستخدمين
- `src/app/api/users/stats/route.ts` - إحصائيات المستخدمين
- `src/app/api/security/settings/route.ts` - إعدادات الأمان

### ملفات مساعدة
- `scripts/setup-database.js` - إعداد قاعدة البيانات
- `scripts/test-user-system.js` - اختبار النظام
- `.env.example` - مثال على متغيرات البيئة

## 🔍 التحقق من النجاح

بعد الإعداد، يجب أن تتمكن من:

1. ✅ تسجيل الدخول بالمستخدمين الافتراضيين
2. ✅ عرض وتعديل إعدادات الأمان
3. ✅ إدارة المستخدمين (إضافة، تعديل، حذف)
4. ✅ تغيير كلمات المرور مع التحقق من السياسة
5. ✅ حماية الحسابات من المحاولات المتكررة

## 🛠️ استكشاف الأخطاء

### خطأ في الاتصال بقاعدة البيانات
- تأكد من تشغيل XAMPP وخدمة MySQL
- تحقق من إعدادات الاتصال في `.env.local`
- تأكد من صحة اسم المستخدم وكلمة المرور

### الجداول غير موجودة
- قم بتشغيل ملف SQL يدوياً في phpMyAdmin
- تأكد من إنشاء قاعدة البيانات `hr_system`

### أخطاء في API
- تحقق من console المتصفح للأخطاء
- تأكد من تشغيل التطبيق على المنفذ الصحيح (9004)
- تحقق من صحة JWT_SECRET في `.env.local`

## 📝 الخطوات التالية

1. **اختبر النظام** باستخدام `npm run test-db`
2. **سجل دخول** بأحد المستخدمين الافتراضيين
3. **اذهب إلى قسم الإعدادات** وجرب تعديل إعدادات الأمان
4. **أضف مستخدمين جدد** من واجهة إدارة المستخدمين
5. **اختبر تغيير كلمة المرور** والتحقق من السياسة

النظام الآن مربوط بالكامل مع قاعدة البيانات ويدعم جميع متطلبات المشروع!
